DB

Proc


uspAddAddress proc.:
CREATE PROCEDURE dbo.uspAddAddress
    @pLogin NVARCHAR(50), 
    @pAddress1 NVARCHAR(120),
    @pAddress2 NVARCHAR(120),
    @pAddress3 NVARCHAR(120),
    @pPLZ INT,
    @pCity_name nvarchar(50),
    @pState_name nvarchar(20),
    @pCountry nvarchar(20),
    @responseMessage NVARCHAR(250) OUTPUT
AS
BEGIN
    BEGIN TRYayu

        INSERT INTO dbo.user_address (login_name, address_1, address_2, address_3, PLZ, city_name, state_name, Country)
        VALUES(@pLogin, @pAddress1, @pAddress2, @pAddress3, @pPLZ, @pCity_name, @pState_name, @pCountry)

       SET @responseMessage='Success'

    END TRY
    BEGIN CATCH
        SET @responseMessage=ERROR_MESSAGE() 
    END CATCH

END



uspAddCategories proc:
CREATE PROCEDURE dbo.uspAddCategories
    @pCategorie NVARCHAR(50), 
    @pDescription NVARCHAR(50),
    @pParentID int
AS 
BEGIN
    insert into categories (cat_name, cat_des, par_id) values(@pCategorie, @pDescription, @pParentID);
END;



uspAddUser proc:
CREATE PROCEDURE dbo.uspAddUser
    @pLogin NVARCHAR(50), 
    @pPassword NVARCHAR(50),
    @pEmail NVARCHAR(50),
    @responseMessage NVARCHAR(250) OUTPUT
AS
BEGIN
    SET NOCOUNT ON

    DECLARE @salt UNIQUEIDENTIFIER=NEWID()
    BEGIN TRY

        INSERT INTO dbo.users (login_name, password_hash, salt, email)
        VALUES(@pLogin, HASHBYTES('SHA2_512', @pPassword+CAST(@salt AS NVARCHAR(36))), @salt, @pEmail)

       SET @responseMessage='Success'

    END TRY
    BEGIN CATCH
        SET @responseMessage=ERROR_MESSAGE() 
    END CATCH

END



uspLogin proc:
ALTER PROCEDURE dbo.uspLogin
    @pLoginName NVARCHAR(254),
    @pPassword NVARCHAR(50),
    @responseMessage NVARCHAR(250)='' OUTPUT
AS
BEGIN

    SET NOCOUNT ON

    DECLARE @userID INT

    IF EXISTS (SELECT TOP 1 user_id FROM dbo.users WHERE login_name=@pLoginName)
    BEGIN
        SET @userID=(SELECT user_id FROM dbo.users WHERE login_name=@pLoginName AND password_Hash=HASHBYTES('SHA2_512', @pPassword+CAST(Salt AS NVARCHAR(36))))

       IF(@userID IS NULL)
           SET @responseMessage='Incorrect password'
       ELSE 
           SET @responseMessage='User successfully logged in'
           SELECT login_name, first_name FROM dbo.users WHERE login_name=@pLoginName
    END
    ELSE
       SET @responseMessage='Invalid login'

END



uspUserInfo proc:
CREATE PROCEDURE dbo.uspUserInfo
    @pLogin NVARCHAR(50), 
    @pPassword NVARCHAR(50)

AS    
BEGIN
    select first_name, last_name, users.login_name, email , admin_rights, profile_pic_url, address_1, address_2, address_3, city_name, state_name, Country, PLZ 
    from dbo.users LEFT JOIN  dbo.user_address 
    on users.login_name = user_address.login_name
    where users.login_name= @pLogin and users.password_hash = HASHBYTES('SHA2_512', @pPassword+CAST(salt AS NVARCHAR(36)));
END


/*Update user info
CREATE PROCEDURE dbo.uspUpdateUser
    @pOldLogin NVARCHAR(50),
    @pOldPass NVARCHAR(50),
    @pLogin NVARCHAR(50),
    @pLogin NVARCHAR(50),
    @pFirstname NVARCHAR(50),
    @plast_name NVARCHAR(50),
    @pEmail NVARCHAR(50),
    @pProfilePicUrl NVARCHAR(50),
    @responseMessage NVARCHAR(250) OUTPUT
AS
BEGIN
    SET NOCOUNT ON
    BEGIN TRY

        UPDATE dbo.users
	SET(login_name=@pLogin, first_name=@pFirstname, last_name@plast_name, email=@pEmail, profile_pic_url=@pProfilePicUrl)
	WHERE (

       SET @responseMessage='Success'

    END TRY
    BEGIN CATCH
        SET @responseMessage=ERROR_MESSAGE() 
    END CATCH

END
*/

/*Update user info
CREATE PROCEDURE dbo.uspUpdatePassword
    @pLogin NVARCHAR(50),
    @pOldPass NVARCHAR(50),
    @pNewPass NVARCHAR(50),
    @responseMessage NVARCHAR(250) OUTPUT

AS
BEGIN
    SET NOCOUNT ON
	DECLARE @salt UNIQUEIDENTIFIER=NEWID()
    BEGIN TRY

        UPDATE dbo.users
	SET(password_hash=@pNewPass+CAST(@salt AS NVARCHAR(36)), Salt=@salt)
	WHERE (@pLogin=login_name AND @pOldPass=password_hash+CAST(Salt))

       SET @responseMessage='Password changed Successfully'

    END TRY
    BEGIN CATCH
        SET @responseMessage=ERROR_MESSAGE() 
    END CATCH
END
*/

CREATE PROCEDURE dbo.uspServices
    @pLogin NVARCHAR(50), 
    @pservice NVARCHAR(50),
	@pmore_info NVARCHAR(50)

AS    
BEGIN
    INSERT INTO dbo.service_prividers_ref (user_id, service_id, more_info) 
	values(
	(select user_id
		from dbo.users
		where login_name = @pLogin),
	(select id
		from dbo.services
		where id = @pservice),
	(@pmore_info)
	)

END
